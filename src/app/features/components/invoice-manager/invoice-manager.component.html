<!-- Barra superior -->
<header class="topbar">
    <div class="brand">
        <span class="icon">ðŸ§¾</span>
        <div>
            <h1>GestiÃ³n de Facturas</h1>
            <p>Sistema de procesamiento automÃ¡tico</p>
        </div>
    </div>

    <button class="btn-outline">Cerrar SesiÃ³n</button>
</header>

<main class="container">
    <!-- Lista -->
    <section class="list">
        <div class="facts">
            <h2>Mis Facturas</h2>
            <!-- <p>Facturas:  {{getCorrectInvoices()}} de {{getTotalInvoices()}}</p> -->
            <p>Facturas: {{ correctInvoices()}} de 0</p>
        </div>

        <div class="card" *ngFor="let row of invoices()">
            <div class="left">
                <span class="error-dot">!</span>
                <div class="meta">
                    <div class="name">{{ row.fileName }}</div>
                    <div class="date">{{ row.createdAt }}</div>
                </div>
            </div>

            <div class="right">
                <span class="chip danger" *ngIf="row.status === 'fallido'">Fallido</span>
                <button class="btn" (click)="open(row)">Corregir</button>
            </div>
        </div>
    </section>
</main>

<!-- Modal -->
<div class="modal-backdrop" *ngIf="selectedInvoice() as inv" (click)="closeModal()"></div>

<div class="modal" *ngIf="selectedInvoice() as inv" role="dialog" aria-modal="true">
    <div class="modal-header">
        <h3>
            Editar Factura: {{ inv.fileName }}
            <small *ngIf="lastNumDoc() !== null" style="font-weight:400;color:#6b7280;margin-left:8px;">
                Â· Doc #{{ lastNumDoc() }}
            </small>
        </h3>
    </div>


    <div class="modal-body">
        <!-- PDF -->
        <div class="pdf-pane">
            <ngx-extended-pdf-viewer [src]="resolvedSrc" [height]="'100%'" [zoom]="'page-width'"
                [showOpenFileButton]="false" [showSecondaryToolbarButton]="true">
            </ngx-extended-pdf-viewer>

            <!-- <iframe [src]="'https://pr99.esphera.ai/uploads/00_25003388.pdf'"></iframe> -->
            <!-- <pdf-viewer [src]="'https://pr99.esphera.ai/uploads/00_25003388.pdf'" [render-text]="true"
                [original-size]="false" ></pdf-viewer> -->
        </div>

        <!-- Formulario ligado 1:1 a InvoiceRow -->
        <form class="form" [formGroup]="form" (ngSubmit)="saveDataAndSend()">
            <h4>Datos de la Factura</h4>

            <label> NÃºmero de Factura
                <input formControlName="numero_factura">
            </label>

            <label> Fecha de Factura
                <input type="date" formControlName="fecha" placeholder="dd/mm/aaaa">
            </label>

            <label> Nombre del Proveedor
                <input formControlName="nombre_proveedor" placeholder="Nombre de la empresa">
            </label>

            <label> NIF/CIF Proveedor (emisiÃ³n)
                <input formControlName="nif_emision">
            </label>

            <label> NIF/CIF Receptor
                <input formControlName="nif_receptor">
            </label>

            <label> Subtotal (â‚¬)
                <input type="number" step="0.01" formControlName="base1">
            </label>

            <label> IVA (% o â‚¬)
                <input type="number" step="0.01" formControlName="iva1">
            </label>

            <label> Importe Total (â‚¬)
                <input type="number" step="0.01" formControlName="importe_total">
            </label>

            <!-- Campos adicionales Ãºtiles -->
            <label> MÃ©todo de pago
                <input formControlName="metodo_pago" placeholder="Transferencia, tarjetaâ€¦">
            </label>

            <label> Prefijo
                <input formControlName="prefijo" placeholder="Ej: F-2024">
            </label>

            <!-- Ocultos en UI pero parte del modelo -->
            <input type="hidden" formControlName="url">
            <input type="hidden" formControlName="valid">

            <div class="actions">
                <button type="submit" class="btn-primary">ðŸ’¾ Guardar y Enviar</button>
            </div>
        </form>
    </div>
</div>